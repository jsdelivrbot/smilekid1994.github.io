<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Secure SSH Server</title>
  <meta name="description" content="Sau khi cài đặt server với một password đủ mạnh thì chúng ta đã khá yêntâm với sự an toàn của server. Nhưng để chạy trong một thời gian dài thìnên thay đổi v...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://smilekid1994.github.io/2015/11/24/secure-ssh-server.html">
  <link rel="alternate" type="application/rss+xml" title="Just a small corner" href="https://smilekid1994.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Just a small corner</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Secure SSH Server</h1>
    <p class="post-meta">Nov 24, 2015</p>
  </header>

  <article class="post-content">
    <p>Sau khi cài đặt server với một password đủ mạnh thì chúng ta đã khá yên
tâm với sự an toàn của server. Nhưng để chạy trong một thời gian dài thì
nên thay đổi và bổ sung một vài thứ thay vì giữ mọi thứ mặc định.</p>

<h2>Sử dụng phiên bản mới nhất</h2>

<p>Nâng cấp phiên bản mới nhất đi theo OS hoặc có thể cài đặt từ mã nguồn.</p>

<p><a href="http://www.openssh.com/portable.html">http://www.openssh.com/portable.html</a></p>

<p>Chú ý backup các file config nếu cần thiết và build với tùy chọn
<code>--with-pam</code> có thể sau này sẽ cần dùng.</p>

<h2>Đổi port</h2>
<div class="highlight"><pre><code class="language-" data-lang="">Port 2222
</code></pre></div>
<p>Nhiều người cho rằng việc này không cần thiết nhưng sau một thời gian
dài làm việc với server, mình thấy nên đổi. Có một số trường hợp do bất
cẩn chưa setup firewall, dùng weak password nên đã bị chiếm quyền. Dù
khả năng xảy ra là nhỏ nhưng với một admin thì vẫn nên cẩn thận.</p>

<h2>Đổi host nếu cần thiết</h2>
<div class="highlight"><pre><code class="language-" data-lang="">ListenAddress 0.0.0.0
</code></pre></div>
<p>Mặc định thì sshd sẽ listen trên tất cả các IPs của server (wan, lan các
kiểu). Trong một số trường hợp chúng ta chỉ cho phép ssh qua LAN thì
cũng nên điều chỉnh cho chắc.</p>
<div class="highlight"><pre><code class="language-" data-lang="">ListenAddress 192.168.2.22
</code></pre></div>
<h2>Vô hiệu hóa tài khoản root</h2>
<div class="highlight"><pre><code class="language-" data-lang="">PermitRootLogin no
</code></pre></div>
<p>Sau khi tạo một tài khoản có quyền sudo chúng ta có thể tắt đăng nhập
qua tài khoản root. Việc này cũng giống như việc đổi port và host, có
thể tránh được một số công cụ quét. Nếu cần sử dụng root có thể su từ
tài khoản thường sang.</p>

<h2>Chỉ định user có thể đăng nhập</h2>

<p>Chỉ định các user có thể đăng nhập vào hệ thống. Nếu dùng cách này thì
không cẩn vô hiệu tài khoản root, chỉ cần không đưa root vào danh sách.</p>
<div class="highlight"><pre><code class="language-" data-lang="">AllowUsers user1
AllowUsers user2
AllowUsers user3
</code></pre></div>
<h2>Sử dụng Public/Private keys để xác thực</h2>

<p>Với cách xác thực này thì máy tính nào có private key tương ứng với
public key được lưu trên server thì mới có thể đăng nhập. Cách này rất
an toàn và được khuyến khích sử dụng mặc định. Khi tạo cặp keys thì lưu
ý nên để passphrase tránh trường hợp mất máy hoặc ai đó xin được key của
mình :D.</p>

<h2>Bỏ đăng nhập bằng mật khẩu</h2>

<p>Sử dụng keys để đăng nhập thì chúng ta nên bỏ đăng nhập bằng mật khẩu,
chỉ những ai có key mới đăng nhập được.</p>
<div class="highlight"><pre><code class="language-" data-lang=""># Disable password authentication forcing use of keys
PasswordAuthentication no
</code></pre></div>
<h2>Sử dụng firewall</h2>

<p>Để thêm an toàn chúng ta có thể sử dụng iptables để limit ip và limit
rate.</p>
<div class="highlight"><pre><code class="language-" data-lang="">iptables -A INPUT -p tcp --dport 2222 -m state --state NEW -m recent --set --name ssh --rsource
iptables -A INPUT -p tcp -m tcp --dport 2222 -m state --state NEW -m recent --update --seconds 60 --hitcount 6 --rttl --name SSH --rsource -j REJECT --reject-with icmp-port-unreachable
iptables -A INPUT -p tcp -s 192.168.2.2 --dport 2222 -j ACCEPT
iptables -A INPUT -j DROP
</code></pre></div>
<p>Từ chối nếu có quá 6 kết nối trong 1 phút và chỉ chấp nhận kết nối từ
192.168.2.2.</p>

<p>Nếu hệ thống cần mở cho nhiều user từ nhiều nơi truy cập thì nên chặn
một số IPs đen. Danh sách thì có nhiều nguồn, một trong số đó là
<a href="http://www.openbl.org">http://www.openbl.org</a>. Theo mình thì cứ Tàu và Nga ngố là bem hết ^^</p>

<h2>Bật đăng nhập 2 lần</h2>

<p>Sư dụng PAM để bật đăng nhập 2 lần với Google Authenticator. Sử dụng
phần này thì cần build bản openssh với <code>--with-pam</code> và dùng phiên bản
openssl từ 6.4 (hình như thế, cứ xài bản mới nhất cho chắc ăn).</p>

<p>Cài luôn từ repo của OS gói <code>google-authenticator</code> (tên gói có thể khác
ở các OSs khác nhau).
Hoặc build từ source</p>
<div class="highlight"><pre><code class="language-" data-lang="">https://github.com/google/google-authenticator/tree/master/libpam
</code></pre></div>
<p>Thư viện sẽ được cài đặt tại <code>/lib64/security/pam_google_authenticator.so</code></p>

<p>Cấu hình <code>sshd_config</code></p>
<div class="highlight"><pre><code class="language-" data-lang="">ChallengeResponseAuthentication yes
UsePAM yes
AuthenticationMethods publickey,keyboard-interactive
PasswordAuthentication no
</code></pre></div>
<p>Cấu hình PAM <code>/etc/pam.d/sshd</code></p>
<div class="highlight"><pre><code class="language-" data-lang="">auth required pam_google_authenticator.so
##
auth       required pam_sepermit.so
#auth       include      password-auth
</code></pre></div>
<p>Chú ý comment password-auth để bỏ qua yêu cầu nhập password.</p>

<p>Để lấy verification code chạy lệnh: <code>google-authenticator</code> và làm theo
hướng dẫn. Lưu lại mấy cái code backup để phòng khi mưa gió.</p>

<p>Kick hết các users đang đăng nhập vào hệ thống để test thử. Sau khi nhập
passphrase là yêu cầu nhập verification code.</p>
<div class="highlight"><pre><code class="language-" data-lang="">sudo /etc/init.d/sshd restart
sudo skill -KILL -u user
</code></pre></div>
<h2>Check log thường xuyên</h2>

<p>Thường xuyên theo dõi log để phát hiện sớm những trường hợp khả nghi.
Phát hiện sớm là bộ môn rất quan trọng trong việc quản trị hệ thống.</p>

<h2>Lưu ý</h2>

<ul>
<li>Sau khi sửa cấu hình thì reload lại sshd</li>
<li>Luôn giữ lại 1 shell backup, tránh tự chặt tay</li>
<li>Cẩn thận khi thao tác với iptables, nên đặt lệnh clear nếu không chắc
chắn</li>
</ul>

<h2>Tham khảo</h2>

<ol>
<li><a href="https://wiki.centos.org/HowTos/Network/SecuringSSH">https://wiki.centos.org/HowTos/Network/SecuringSSH</a></li>
<li><a href="http://www.openssh.com/">http://www.openssh.com/</a></li>
<li><a href="https://github.com/google/google-authenticator/wiki">https://github.com/google/google-authenticator/wiki</a></li>
</ol>

    
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES * * */
          var disqus_shortname = 'smilekid1994';

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Just a small corner</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Just a small corner</li>
          <li><a href="mailto:smilekid1994@gmail.com">smilekid1994@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/smilekid1994">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">smilekid1994</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Hạnh phúc là con đường chứ không phải đích đến.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
